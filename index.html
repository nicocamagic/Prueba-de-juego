<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <!-- Viewport fit cover es vital para que ocupe toda la pantalla en Android -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>App de Magia</title>
    <link rel="manifest" href="manifest.json">

    <style>
        body {
            background-color: black;
            margin: 0;
            padding: 0;
            /* dvh asegura que ignore las barras del sistema en móviles */
            height: 100dvh;
            width: 100vw;
            display: flex;
            flex-direction: row;
            overflow: hidden;
            touch-action: none;
        }

        .touch-zone {
            height: 100%;
            z-index: 10;
        }

        #decenas {
            width: 35%;
        }

        #unidades {
            width: 35%;
        }

        #ejecutar {
            width: 30%;
            /* Gris ligeramente más claro para ser visible en pantallas OLED */
            background-color: #151515;
            border-left: 1px solid #1f1f1f;
            border-right: 1px solid #1f1f1f;
            transition: opacity 0.5s ease;
            z-index: 20;
        }

        .hidden {
            opacity: 0 !important;
            pointer-events: none;
        }

        #reset {
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            /* Un poco más grande para facilitar el toque invisible */
            height: 100px;
            z-index: 40;
        }

        #debug {
            position: absolute;
            bottom: 15px;
            left: 15px;
            color: #111;
            /* Color casi negro para que solo tú lo veas de cerca */
            font-family: sans-serif;
            font-size: 12px;
            pointer-events: none;
            z-index: 50;
        }
    </style>
</head>

<body>

    <div id="decenas" class="touch-zone" onclick="sumar(10)"></div>
    <div id="ejecutar" class="touch-zone" onclick="iniciarEfecto()"></div>
    <div id="unidades" class="touch-zone" onclick="sumar(1)"></div>
    <div id="reset" onclick="limpiar()"></div>

    <div id="debug">0</div>

    <script>
        let videoTrack = null;
        let contador = 0;

        async function prepararCamara() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment" }
                });
                videoTrack = stream.getVideoTracks()[0];

                if (navigator.vibrate) navigator.vibrate(40);
                console.log("Hardware de cámara vinculado correctamente.");
            } catch (e) {
                console.error("Error al acceder a la cámara:", e);
                // Usamos el [Web API de Vibración](https://developer.mozilla.org) para avisar del error de forma táctil
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            }
        }

        function sumar(n) {
            if (!videoTrack) prepararCamara();
            contador += n;
            document.getElementById('debug').innerText = contador;
            if (navigator.vibrate) navigator.vibrate(25);
        }

        function limpiar() {
            contador = 0;
            document.getElementById('debug').innerText = 0;
            if (navigator.vibrate) navigator.vibrate([40, 40, 40]);
        }

        async function encender(estado) {
            if (videoTrack) {
                try {
                    const capabilities = videoTrack.getCapabilities();
                    if (capabilities.torch) {
                        await videoTrack.applyConstraints({
                            advanced: [{ torch: estado }]
                        });
                    }
                } catch (e) {
                    console.error("Error flash:", e);
                }
            }
        }

        async function iniciarEfecto() {
            // El contador 0 o falta de track cancela la ejecución
            if (contador === 0 || !videoTrack) return;

            const boton = document.getElementById('ejecutar');
            const vueltas = contador;

            boton.classList.add('hidden');
            contador = 0;
            document.getElementById('debug').innerText = "";

            // Retardo de 3 segundos para alejar el móvil o posicionarte
            await new Promise(r => setTimeout(r, 3000));

            for (let i = 0; i < vueltas; i++) {
                await encender(true);
                await new Promise(r => setTimeout(r, 350));
                await encender(false);
                await new Promise(r => setTimeout(r, 650));
            }

            // Restaurar interfaz
            setTimeout(() => {
                boton.classList.remove('hidden');
                document.getElementById('debug').innerText = "0";
                if (navigator.vibrate) navigator.vibrate(60);
            }, 1000);
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(() => { });
            });
        }
    </script>
</body>

</html>
