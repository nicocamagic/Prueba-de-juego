<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />

    <title>App de Magia</title>

    <style>
      body {
        background-color: black;
        margin: 0;
        padding: 0;
        height: 100dvh;
        width: 100vw;
        display: flex;
        flex-direction: row;
        overflow: hidden;
        touch-action: none;
      }

      .touch-zone {
        height: 100%;
        z-index: 10;
      }
      #decenas {
        width: 35%;
      }
      #unidades {
        width: 35%;
      }

      #ejecutar {
        width: 30%;
        background-color: #151515;
        border-left: 1px solid #1f1f1f;
        border-right: 1px solid #1f1f1f;
        transition: opacity 0.5s ease;
        z-index: 20;
      }

      .hidden {
        opacity: 0 !important;
        pointer-events: none;
      }

      #reset {
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        z-index: 40;
      }

      #debug {
        position: absolute;
        bottom: 15px;
        left: 15px;
        color: #111;
        font-size: 12px;
        pointer-events: none;
        z-index: 50;
      }
    </style>
  </head>

  <body>
    <div id="decenas" class="touch-zone" onclick="sumar(10)"></div>
    <div id="ejecutar" class="touch-zone" onclick="iniciarEfecto()"></div>
    <div id="unidades" class="touch-zone" onclick="sumar(1)"></div>
    <div id="reset" onclick="limpiar()"></div>

    <div id="debug">0</div>

    <script>
      let contador = 0;
      let camActiva = false;

      function sumar(n) {
        contador += n;
        document.getElementById("debug").innerText = contador;
        if (navigator.vibrate) navigator.vibrate(25);
      }

      function limpiar() {
        contador = 0;
        document.getElementById("debug").innerText = 0;
        if (navigator.vibrate) navigator.vibrate([40, 40, 40]);
      }

      function flashOn() {
        if (camActiva) return;

        navigator.camera.getPicture(
          () => {},
          () => {},
          {
            quality: 1,
            destinationType: Camera.DestinationType.NATIVE_URI,
            cameraDirection: Camera.Direction.BACK,
            flashMode: Camera.FlashMode.ON,
            targetWidth: 1,
            targetHeight: 1,
            saveToPhotoAlbum: false,
          },
        );
        camActiva = true;
      }

      function flashOff() {
        if (!camActiva) return;
        navigator.camera.cleanup();
        camActiva = false;
      }

      async function iniciarEfecto() {
        if (contador === 0) return;

        const boton = document.getElementById("ejecutar");
        boton.classList.add("hidden");

        const repeticiones = contador;
        contador = 0;
        document.getElementById("debug").innerText = "";

        await new Promise((r) => setTimeout(r, 3000));

        for (let i = 0; i < repeticiones; i++) {
          flashOn();
          await new Promise((r) => setTimeout(r, 350));
          flashOff();
          await new Promise((r) => setTimeout(r, 650));
        }

        setTimeout(() => {
          boton.classList.remove("hidden");
          document.getElementById("debug").innerText = "0";
          if (navigator.vibrate) navigator.vibrate(60);
        }, 1000);
      }

      document.addEventListener("deviceready", () => {
        console.log("Cordova listo");
      });
    </script>
  </body>
</html>
